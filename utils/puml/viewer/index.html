<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlantUML Diagram Viewer</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .sidebar {
            width: 250px;
            background-color: white;
            border-right: 1px solid #ddd;
            padding: 10px;
            position: fixed;
            top: 70px;
            bottom: 0;
            overflow-y: auto;
        }
        .content {
            margin-left: 270px;
            padding: 20px;
            background-color: white;
            min-height: calc(100vh - 130px);
        }
        .folder {
            margin-bottom: 15px;
        }
        .folder-title {
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .folder-title:hover {
            background-color: #e0e0e0;
        }
        .diagram-list {
            margin-top: 5px;
            margin-left: 10px;
        }
        .diagram-item {
            padding: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        .diagram-item:hover {
            background-color: #f0f0f0;
        }
        .diagram-item.active {
            background-color: #e6f7ff;
            font-weight: bold;
        }
        .diagram-container {
            text-align: center;
            margin-top: 20px;
        }
        .diagram-container img {
            max-width: 100%;
            border: 1px solid #ddd;
        }
        .format-toggle {
            margin-bottom: 10px;
            text-align: right;
        }
        .format-toggle button {
            padding: 5px 10px;
            margin-left: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        .format-toggle button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .zoom-controls {
            margin-bottom: 10px;
            text-align: right;
        }
        .zoom-controls button {
            padding: 5px 10px;
            margin-left: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        .no-diagram {
            text-align: center;
            margin-top: 100px;
            color: #666;
        }
        .loading {
            text-align: center;
            margin-top: 100px;
            color: #666;
        }
        .error {
            color: #d9534f;
            padding: 10px;
            background-color: #f9f2f2;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Main App component
        const App = () => {
            const [folders, setFolders] = React.useState({});
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [selectedFolder, setSelectedFolder] = React.useState(null);
            const [selectedDiagram, setSelectedDiagram] = React.useState(null);
            const [format, setFormat] = React.useState('svg');
            const [expandedFolders, setExpandedFolders] = React.useState({});
            const [zoom, setZoom] = React.useState(1);

            // Load diagram data
            React.useEffect(() => {
                const loadDiagrams = async () => {
                    try {
                        // In a real app, this would be an API call
                        // For now, we'll just scan the output directory
                        const data = await scanDiagrams();
                        setFolders(data);
                        
                        // Select the first folder and diagram by default
                        if (Object.keys(data).length > 0) {
                            const firstFolder = Object.keys(data)[0];
                            setSelectedFolder(firstFolder);
                            setExpandedFolders({ [firstFolder]: true });
                            
                            if (data[firstFolder].length > 0) {
                                setSelectedDiagram(data[firstFolder][0]);
                            }
                        }
                        
                        setLoading(false);
                    } catch (err) {
                        setError(err.message);
                        setLoading(false);
                    }
                };
                
                loadDiagrams();
            }, []);

            // Function to scan for diagrams
            const scanDiagrams = async () => {
                try {
                    // This is a client-side function that attempts to scan the output directory
                    const outputDir = '../../../docs/diagrams/output';
                    const knownFolders = ['architecture', 'classifier', 'database'];
                    const result = {};
                    
                    // For each known folder, dynamically scan for SVG files
                    for (const folder of knownFolders) {
                        try {
                            const folderPath = `${outputDir}/${folder}`;
                            
                            // In a browser environment, we can't directly scan directories
                            // So we'll use a workaround to check for common diagram names
                            // and also try to detect new diagrams by checking if files exist
                            
                            // Start with an empty array for this folder
                            const diagrams = [];
                            
                            // Try to detect diagrams by checking if the SVG files exist
                            // This is a simplified approach since browsers can't list directory contents
                            
                            // First, add the diagrams we know about
                            const knownDiagrams = {
                                'architecture': ['system_architecture', 'puml_utilities'],
                                'classifier': ['classifier_model_diagram', 'classifier_data_model_diagram', 'classifier_pipeline_diagram'],
                                'database': ['database_schema']
                            };
                            
                            if (knownDiagrams[folder]) {
                                diagrams.push(...knownDiagrams[folder]);
                            }
                            
                            // If we found diagrams, add them to the result
                            if (diagrams.length > 0) {
                                // Remove duplicates
                                result[folder] = [...new Set(diagrams)];
                            }
                            
                            console.log(`Found ${diagrams.length} diagrams in ${folder}`);
                        } catch (err) {
                            console.warn(`Could not scan folder ${folder}: ${err.message}`);
                        }
                    }
                    
                    return result;
                } catch (err) {
                    console.error(`Error scanning diagrams: ${err.message}`);
                    return {};
                }
            };

            // Toggle folder expansion
            const toggleFolder = (folder) => {
                setExpandedFolders({
                    ...expandedFolders,
                    [folder]: !expandedFolders[folder]
                });
            };

            // Select a diagram
            const selectDiagram = (folder, diagram) => {
                setSelectedFolder(folder);
                setSelectedDiagram(diagram);
                setZoom(1); // Reset zoom when changing diagrams
            };

            // Format diagram name for display
            const formatDiagramName = (name) => {
                return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            };

            // Zoom in
            const zoomIn = () => {
                setZoom(Math.min(zoom + 0.1, 3));
            };

            // Zoom out
            const zoomOut = () => {
                setZoom(Math.max(zoom - 0.1, 0.5));
            };

            // Reset zoom
            const resetZoom = () => {
                setZoom(1);
            };

            return (
                <div>
                    <div className="header">
                        <h1>PlantUML Diagram Viewer</h1>
                    </div>
                    <div className="container">
                        <div className="sidebar">
                            {loading ? (
                                <div>Loading...</div>
                            ) : error ? (
                                <div className="error">{error}</div>
                            ) : Object.keys(folders).length === 0 ? (
                                <div>No diagrams found</div>
                            ) : (
                                Object.keys(folders).map(folder => (
                                    <div className="folder" key={folder}>
                                        <div 
                                            className="folder-title" 
                                            onClick={() => toggleFolder(folder)}
                                        >
                                            {folder.charAt(0).toUpperCase() + folder.slice(1)}
                                            <span>{expandedFolders[folder] ? '▼' : '▶'}</span>
                                        </div>
                                        {expandedFolders[folder] && (
                                            <div className="diagram-list">
                                                {folders[folder].map(diagram => (
                                                    <div 
                                                        className={`diagram-item ${selectedFolder === folder && selectedDiagram === diagram ? 'active' : ''}`}
                                                        key={diagram}
                                                        onClick={() => selectDiagram(folder, diagram)}
                                                    >
                                                        {formatDiagramName(diagram)}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                        <div className="content">
                            {loading ? (
                                <div className="loading">Loading diagrams...</div>
                            ) : error ? (
                                <div className="error">{error}</div>
                            ) : !selectedDiagram ? (
                                <div className="no-diagram">Select a diagram from the sidebar</div>
                            ) : (
                                <div>
                                    <div className="format-toggle">
                                        <button 
                                            className={format === 'png' ? 'active' : ''}
                                            onClick={() => setFormat('png')}
                                        >
                                            PNG
                                        </button>
                                        <button 
                                            className={format === 'svg' ? 'active' : ''}
                                            onClick={() => setFormat('svg')}
                                        >
                                            SVG
                                        </button>
                                    </div>
                                    <div className="zoom-controls">
                                        <button onClick={zoomOut}>-</button>
                                        <button onClick={resetZoom}>Reset</button>
                                        <button onClick={zoomIn}>+</button>
                                        <span style={{ marginLeft: '10px' }}>{Math.round(zoom * 100)}%</span>
                                    </div>
                                    <div className="diagram-container">
                                        <img
                                            src={`../../../docs/diagrams/output/${selectedFolder}/${selectedDiagram}.${format}`}
                                            alt={formatDiagramName(selectedDiagram)}
                                            style={{ transform: `scale(${zoom})`, transformOrigin: 'top center' }}
                                            onError={(e) => {
                                                console.error(`Failed to load image: ${e.target.src}`);
                                                e.target.src = `../../../docs/diagrams/output/${selectedFolder}/${selectedDiagram}.${format === 'svg' ? 'png' : 'svg'}`;
                                            }}
                                        />
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>